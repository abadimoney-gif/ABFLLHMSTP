-- [[ MEGA INTEGRATED SYSTEM 2026 - GHOST VM & SMOOTH FALL EDITION ]]
-- Merged & Optimized for Performance

-- [[ 0x1: CONFIGURATION STORAGE ]]
getgenv().GhostConfig = {
    StiffEnabled = true,
    FloatHeight = 2.8,
    AntiDetect = true,
    TeleportKey = "/goto",
    FlySpeed = 100,
    WalkSpeed = 100,
    JumpPower = 150, -- Anda bisa mengubah ini ke 50 jika ingin lompatan normal
    HitboxSize = 25,
    RingRadius = 20,
    RingActive = true,
    BlackholeActive = false,
    Noclip = false,
    Flying = false,
    Aimlock = false,
    -- Smooth Fall Config
    SmoothFallEnabled = true,
    FallSpeed = -12, -- Semakin kecil (negatif), semakin lambat jatuhnya
    Opcodes = {0x1, 0x2, 0x3}
}

-- [[ 0x2: SERVICES ]]
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- [[ 0x3: UI NOTIFICATION & HUD ]]
local function Notify(title, text)
    pcall(function()
        StarterGui:SetCore("SendNotification", {
            Title = title,
            Text = text,
            Icon = "rbxthumb://type=Asset&id=131599029580950&w=420&h=420",
            Duration = 5
        })
    end)
end

local ScreenGui = Instance.new("ScreenGui", game:GetService("CoreGui"))
local KeybindFrame = Instance.new("TextLabel", ScreenGui)
KeybindFrame.Size = UDim2.new(0, 250, 0, 120)
KeybindFrame.Position = UDim2.new(0, 10, 1, -130)
KeybindFrame.BackgroundTransparency = 1
KeybindFrame.Text = " [ KEYBINDS ]\n F: Fly | G: Noclip\n B: Blackhole | H: ServerHop\n P: Remote Scan\n RMB: Aimlock\n Auto: Smooth Fall & Anti-Anim"
KeybindFrame.TextColor3 = Color3.fromRGB(255, 255, 255)
KeybindFrame.TextStrokeTransparency = 0
KeybindFrame.TextXAlignment = Enum.TextXAlignment.Left
KeybindFrame.Font = Enum.Font.Code
KeybindFrame.TextSize = 14

-- [[ 0x4: CORE INTERPRETER (VM) ]]
local function GhostInterpreter(instruction, data)
    if instruction == 0x1 then -- [[ STIFF & SMOOTH FALL SETUP ]]
        local Char = data
        if not Char then return end
        
        -- Setup BodyVelocity untuk Smooth Fall
        local RootPart = Char:WaitForChild("HumanoidRootPart", 5)
        if RootPart then
            if RootPart:FindFirstChild("SmoothFallBV") then RootPart.SmoothFallBV:Destroy() end
            local bv = Instance.new("BodyVelocity")
            bv.Name = "SmoothFallBV"
            bv.MaxForce = Vector3.new(0, 0, 0)
            bv.Velocity = Vector3.new(0, getgenv().GhostConfig.FallSpeed, 0)
            bv.Parent = RootPart
        end

        local Animate = Char:FindFirstChild("Animate")
        if Animate and getgenv().GhostConfig.StiffEnabled then Animate:Destroy() end
        
        local Hum = Char:FindFirstChildOfClass("Humanoid")
        if Hum then 
            Hum.HipHeight = getgenv().GhostConfig.FloatHeight
            for _, v in pairs(Hum:GetPlayingAnimationTracks()) do v:Stop() end
        end

    elseif instruction == 0x2 then -- [[ ANTI-DETECTION ]]
        local mt = getrawmetatable(game)
        setreadonly(mt, false)
        local oldNamecall = mt.__namecall
        mt.__namecall = newcclosure(function(self, ...)
            local method = getnamecallmethod()
            if method == "FireServer" and (self.Name:find("Report") or self.Name:find("Detect")) then
                return nil
            end
            return oldNamecall(self, ...)
        end)
        setreadonly(mt, true)

    elseif instruction == 0x3 then -- [[ PIVOT TELEPORT ]]
        local target = data
        if LocalPlayer.Character and target.Character then
            LocalPlayer.Character:PivotTo(target.Character:GetPivot() * CFrame.new(0, 2, 0))
        end
    end
end

-- [[ 0x5: UTILITIES ]]
local function FireRemotes()
    local count = 0
    for _, v in pairs(game:GetDescendants()) do 
        if v:IsA("RemoteEvent") then 
            if v.Parent.Name:find("Remote") or v.Name:find("Admin") or v.Name:find("Vip") then 
                v:FireServer()
                count = count + 1
            end 
        end 
    end
    Notify("Remote Scanner", "Mencoba menembus " .. count .. " RemoteEvents")
end

-- [[ 0x6: PHYSICS & COMBAT ENGINE ]]
local RingParts = {}
local function applyHitbox(player)
    if player == LocalPlayer then return end
    player.CharacterAdded:Connect(function(char)
        local hrp = char:WaitForChild("HumanoidRootPart", 5)
        if hrp then
            task.wait(0.5)
            hrp.Size = Vector3.new(getgenv().GhostConfig.HitboxSize, getgenv().GhostConfig.HitboxSize, getgenv().GhostConfig.HitboxSize)
            hrp.Transparency = 0.7
            hrp.CanCollide = false
        end
    end)
end

local function managePart(part)
    if part:IsA("BasePart") and not part.Anchored and not part:IsDescendantOf(LocalPlayer.Character) then
        part.CustomPhysicalProperties = PhysicalProperties.new(0, 0, 0, 0, 0)
        table.insert(RingParts, part)
    end
end

-- [[ 0x7: MAIN LOOPS ]]
RunService.Stepped:Connect(function()
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        local hum = LocalPlayer.Character.Humanoid
        hum.WalkSpeed = getgenv().GhostConfig.WalkSpeed
        hum.JumpPower = getgenv().GhostConfig.JumpPower
        
        if getgenv().GhostConfig.Noclip then
            for _, v in pairs(LocalPlayer.Character:GetDescendants()) do
                if v:IsA("BasePart") then v.CanCollide = false end
            end
        end
    end
    pcall(function() sethiddenproperty(LocalPlayer, "SimulationRadius", math.huge) end)
end)

-- INTEGRATED RENDERSTEPPED (Fly + Aimlock + Smooth Fall)
RunService.RenderStepped:Connect(function()
    local Character = LocalPlayer.Character
    local Root = Character and Character:FindFirstChild("HumanoidRootPart")
    local Hum = Character and Character:FindFirstChildOfClass("Humanoid")
    
    if not Character or not Root or not Hum then return end

    -- 1. Aimlock Logic
    if rmbDown then
        local target, dist = nil, math.huge
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                local d = (Root.Position - p.Character.HumanoidRootPart.Position).Magnitude
                if d < dist then dist = d; target = p.Character.HumanoidRootPart end
            end
        end
        if target then Camera.CFrame = CFrame.new(Camera.CFrame.Position, target.Position) end
    end

    -- 2. Fly Logic
    if getgenv().GhostConfig.Flying and Root:FindFirstChild("GhostFly") then
        local moveDir = Vector3.new(0,0,0)
        if UIS:IsKeyDown(Enum.KeyCode.W) then moveDir += Camera.CFrame.LookVector end
        if UIS:IsKeyDown(Enum.KeyCode.S) then moveDir -= Camera.CFrame.LookVector end
        if UIS:IsKeyDown(Enum.KeyCode.A) then moveDir -= Camera.CFrame.RightVector end
        if UIS:IsKeyDown(Enum.KeyCode.D) then moveDir += Camera.CFrame.RightVector end
        Root.GhostFly.Velocity = moveDir * getgenv().GhostConfig.FlySpeed
        Root.GhostGyro.CFrame = Camera.CFrame
        
        -- Matikan Smooth Fall saat Fly
        if Root:FindFirstChild("SmoothFallBV") then Root.SmoothFallBV.MaxForce = Vector3.new(0,0,0) end
    
    -- 3. Smooth Fall Logic (Hanya jalan jika tidak sedang Fly)
    elseif getgenv().GhostConfig.SmoothFallEnabled then
        local bv = Root:FindFirstChild("SmoothFallBV")
        if bv then
            local state = Hum:GetState()
            if state == Enum.HumanoidStateType.Freefall or state == Enum.HumanoidStateType.Jumping then
                bv.MaxForce = Vector3.new(0, 5000, 0)
                bv.Velocity = Vector3.new(0, getgenv().GhostConfig.FallSpeed, 0)
                -- Paksa state 'Running' untuk hilangkan animasi jatuh/tangan ke atas
                Hum:ChangeState(Enum.HumanoidStateType.Running)
            else
                bv.MaxForce = Vector3.new(0, 0, 0)
            end
        end
    end
end)

-- [[ 0x8: INPUT HANDLER ]]
local rmbDown = false
UIS.InputBegan:Connect(function(input, gpe)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then rmbDown = true end
    if gpe then return end
    
    if input.KeyCode == Enum.KeyCode.F then 
        getgenv().GhostConfig.Flying = not getgenv().GhostConfig.Flying
        local root = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if getgenv().GhostConfig.Flying then
            LocalPlayer.Character.Humanoid.PlatformStand = true
            local bv = Instance.new("BodyVelocity", root)
            bv.Name = "GhostFly"
            bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            local bg = Instance.new("BodyGyro", root)
            bg.Name = "GhostGyro"
            bg.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
        else
            LocalPlayer.Character.Humanoid.PlatformStand = false
            if root:FindFirstChild("GhostFly") then root.GhostFly:Destroy() end
            if root:FindFirstChild("GhostGyro") then root.GhostGyro:Destroy() end
        end
    elseif input.KeyCode == Enum.KeyCode.G then getgenv().GhostConfig.Noclip = not getgenv().GhostConfig.Noclip
    elseif input.KeyCode == Enum.KeyCode.B then getgenv().GhostConfig.BlackholeActive = not getgenv().GhostConfig.BlackholeActive
    elseif input.KeyCode == Enum.KeyCode.P then FireRemotes()
    elseif input.KeyCode == Enum.KeyCode.H then
        local url = "https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"
        local s, res = pcall(function() return HttpService:JSONDecode(game:HttpGet(url)) end)
        if s then
            for _, server in pairs(res.data) do
                if server.playing < server.maxPlayers and server.id ~= game.JobId then
                    TeleportService:TeleportToPlaceInstance(game.PlaceId, server.id, LocalPlayer)
                    break
                end
            end
        end
    end
end)
UIS.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton2 then rmbDown = false end end)

-- [[ 0x9: INITIALIZATION ]]
local function Init()
    local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    GhostInterpreter(0x1, Character)
    
    if getgenv().GhostConfig.AntiDetect then 
        GhostInterpreter(0x2) 
        getgenv().GhostConfig.AntiDetect = false 
    end
    
    -- Load external modules (Optional)
    task.spawn(function()
        pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source"))() end)
    end)
    
    for _, p in pairs(Players:GetPlayers()) do applyHitbox(p) end
    for _, v in pairs(workspace:GetDescendants()) do managePart(v) end
    
    Notify("SYSTEM INTEGRATED", "Ghost VM + Smooth Fall Aktif")
end

-- Events
LocalPlayer.CharacterAdded:Connect(function(Char)
    task.wait(0.5)
    GhostInterpreter(0x1, Char)
end)

LocalPlayer.Chatted:Connect(function(msg)
    local args = msg:split(" ")
    if args[1] == getgenv().GhostConfig.TeleportKey and args[2] then
        local targetName = args[2]:lower()
        for _, v in pairs(Players:GetPlayers()) do
            if v.Name:lower():find(targetName) then GhostInterpreter(0x3, v) break end
        end
    end
end)

Players.PlayerAdded:Connect(applyHitbox)
workspace.DescendantAdded:Connect(managePart)

task.spawn(Init)
print("--- GHOST VM & SMOOTH FALL INTEGRATED 2026 ---")
